---
date: 2021-03-14
spot: å®å®‰å›¾ä¹¦é¦†
sort: Computer Science
tags:
  - TCP
  - Linux
  - NAT
  - Network
  - sysctl
draft: true
---

# è¯‘ï¼šåœ¨å¿™ç¢Œçš„ Linux æœåŠ¡å™¨ä¸Šå¦‚ä½•å¤„ç† TCP TIME-WAIT

è¿™ç¯‡æ–‡ç« æ˜¯æˆ‘åœ¨å¤„ç†ä¸€ä¸ªå›°æ‰°æˆ‘ä»¬å¾ˆä¹…çš„æ•…éšœæ—¶é€šè¿‡ Google â€œå¶ç„¶â€æ‰¾åˆ°çš„ï¼Œç„¶åŽå®ƒçœŸçš„æŠŠé—®é¢˜è§£å†³äº†ã€‚

## å‰æƒ…æè¦

è¯´â€œå¶ç„¶â€æ˜¯å› ä¸ºæˆ‘ä¸€å¼€å§‹æœç´¢æ—¶ç”¨çš„å…³é”®å­— `tcp_tw_reuse` å¹¶ä¸èƒ½è§£å†³é—®é¢˜ï¼Œåªæ˜¯æ°å¥½å®ƒå’Œè¿™ç¯‡æ–‡ç« æœ‰å…³è”ã€‚

å‰é¢æåˆ°çš„æ•…éšœæ˜¯æŒ‡ï¼š**ä½¿ç”¨æµè§ˆå™¨è®¿é—®æˆ‘ä»¬çš„æŸä¸ª Web å¹³å°æ—¶ï¼Œä¼šå°æ¦‚çŽ‡å‡ºçŽ°æµè§ˆå™¨ä¸€ç›´è½¬çš„æƒ…å†µï¼Œåœ¨ç­‰å¾…æ•°åç§’ä¹‹åŽæ‰èƒ½æ­£å¸¸åŠ è½½é¡µé¢ã€‚**

è¿™ä¸ªæ•…éšœä»Žæœ‰äººå‘æˆ‘æå‡ºåˆ°è¢«è§£å†³ï¼ŒåŽ†æ—¶åº”è¯¥è¶…è¿‡ä¸€å¹´ï¼Œå› ä¸ºå®ƒï¼š

- å‡ºçŽ°é¢‘çŽ‡è¾ƒä½Žï¼›
- æ²¡æœ‰è§„å¾‹ï¼Œæ— æ³•ç¨³å®šå¤çŽ°ï¼›
- ä¸å±žäºŽè‡´å‘½æ€§æ•…éšœï¼ŒåŠ ä¸ŠäººåŠ›æœ‰é™ï¼Œåªèƒ½é‡‡å–é•¿æœŸè¿½è¸ªé€æ­¥ç¼©å°æŽ’æŸ¥èŒƒå›´çš„ç­–ç•¥ã€‚

ç”±äºŽå®ƒå‡ºçŽ°é¢‘çŽ‡å®žåœ¨æ˜¯å¤ªä½Žï¼Œå½“åˆ«äººé‡åˆ°å†å‘æˆ‘åé¦ˆæ—¶ï¼Œå¾€å¾€å·²ç»é”™å¤±äº† debug çª—å£ã€‚äºŽæ˜¯ï¼Œæˆ‘æŠŠåˆ«äººåé¦ˆçš„ä¿¡æ¯ä¸Žè‡ªå·±é‡åˆ°æ­¤æ•…éšœæ—¶æ‰€ä½œçš„è§‚å¯Ÿéƒ½è®°å½•åœ¨é¡¹ç›®çš„ Redmind é‡Œï¼Œå¾—åˆ°ä»¥ä¸‹ä¸€äº›åˆæ­¥ç»“è®ºï¼š

1. æ•…éšœå‡ºçŽ°æ—¶ï¼Œå…¶ä»–è®¾å¤‡è®¿é—®æ­¤ Web å¹³å°æ˜¯æ­£å¸¸çš„ï¼›
2. æ•…éšœå‡ºçŽ°æ—¶ï¼Œæµè§ˆå™¨æ‰€åœ¨è®¾å¤‡ `ping` æ­¤ Web å¹³å°æ˜¯æ­£å¸¸çš„ï¼ˆç½‘ç»œå±‚åº”è¯¥æ²¡é—®é¢˜ï¼‰ï¼›
3. æ•…éšœå‡ºçŽ°æ—¶ï¼Œæµè§ˆå™¨æ‰€åœ¨è®¾å¤‡ä½¿ç”¨ `nc` æŽ¢æµ‹æ­¤ Web å¹³å°æ‰€åœ¨ Linux æœåŠ¡å™¨çš„ä»»æ„æœ‰ç›‘å¬å¼€æ”¾ç«¯å£éƒ½å‡ºçŽ°å’Œæµè§ˆå™¨ç±»ä¼¼çš„æ•…éšœï¼ˆä¼ è¾“å±‚å‡ºçŽ°é—®é¢˜ï¼‰ï¼›

ä»Ž `2.` å’Œ `3.` å¯ä»¥æŽ¨æµ‹ï¼Œé—®é¢˜å¤§æ¦‚çŽ‡åœ¨äºŽä¼ è¾“å±‚ã€‚HTTP åè®®åŸºäºŽ TCPï¼Œæ‰€ä»¥å¤§æ¦‚çŽ‡å°±æ˜¯ TCP è¿žæŽ¥å»ºç«‹è¿‡ç¨‹å‡ºçŽ°æ„å¤–ã€‚é‚£ä¹ˆï¼Œå¦‚æžœæ˜¯ UDP åè®®ä¼šæœ‰é—®é¢˜å—ï¼Ÿ

```sh
$ nc -uv IP.IP.IP.IP 6666
Connection to IP.IP.IP.IP port 6666 [udp/*] succeeded!
```

`nc` å‘½ä»¤çš„ UDP å’Œ TCP æ¨¡å¼æœ‰ä¸ªé‡è¦åŒºåˆ«ï¼šä¸ç®¡ `nc` ä»€ä¹ˆç«¯å£ï¼ŒUDP æ¨¡å¼çš„ç»“æžœæ€»ä¼šæ˜¯ `succeeded!`ã€‚ä½†æ˜¯ï¼Œå¦‚æžœåœ¨æœåŠ¡å™¨ç«¯ä½¿ç”¨ `nc` ä»¥ UDP æ¨¡å¼ç›‘å¬ç«¯å£ï¼ˆé˜²ç«å¢™å¼€æ”¾çš„ç«¯å£ï¼‰ï¼Œå½“å®ƒæ”¶åˆ° UDP åŒ…æ—¶ä¼šæ‰“å°å‡º `XXX` å­—ç¬¦ã€‚

äºŽæ˜¯ï¼Œåœ¨æŸæ¬¡æ•…éšœå¤çŽ°æ—¶ï¼Œæˆ‘ä»¥æœ€å¿«é€Ÿåº¦åšäº†å¦‚ä¸‹æ“ä½œï¼š

```sh
# server side
$ sudo nc -luk 0.0.0.0 6666
# waiting for the client to "connect"...
XXXX

# client side
nc -uv IP.IP.IP.IP 6666
```

åœ¨æ€»ç»“å‡ºä¸Šé¢è¿™äº›çŽ°è±¡åŽï¼Œæˆ‘æ‰¾äº†æŸäº‘å”®åŽå·¥ç¨‹å¸ˆå’¨è¯¢ã€‚å¯¹é¢è¯¢é—®æˆ‘æ˜¯å¦ä¿®æ”¹è¿‡æœåŠ¡å™¨çš„ `net.ipv4.tcp_tw_reuse` å‚æ•°ã€‚æˆ‘è¡¨ç¤ºæ²¡æœ‰ï¼ŒåŒæ—¶ä¹Ÿä¸çŸ¥é“è¿™ä¸ªå‚æ•°çš„ä½œç”¨æ˜¯ä»€ä¹ˆã€‚å› æ­¤æœç´¢äº†ä¸€ç•ªè€Œæ‰¾åˆ°ä¸Šæ–‡æåˆ°çš„è¿™ç¯‡æ–‡ç« ï¼Œå¹¶ä¸”æ ¹æ®æ–‡ç« å¯ä»¥åˆ¤æ–­å‡ºé—®é¢˜åœ¨äºŽå¯ç”¨äº†å¦å¤–ä¸€ä¸ª ipv4 å†…æ ¸å‚æ•°ï¼š`net.ipv4.tcp_tw_recycle`ã€‚

### ä¿®æ”¹å†…æ ¸å‚æ•°

`net.ipv4.tcp_tw_recycle` è¿™ä¸ªå†…æ ¸å‚æ•°æ˜¯å“ªä½åŒäº‹å¯ç”¨çš„åº”è¯¥å·²ç»ä¸å¯è€ƒï¼Œä¸è¿‡æˆ‘çŒœä»–å¤§æ¦‚æ˜¯ä¸ºäº†ä¼˜åŒ– TCP è¿žæŽ¥æ•°è€Œåšçš„ä¿®æ”¹ã€‚

å¥½æ¶ˆæ¯æ˜¯è¿™ä¸ªå†…æ ¸å‚æ•°å¯ä»¥åœ¨ Linux è¿è¡Œæ—¶ä¿®æ”¹è€Œä¸å¿…é‡å¯ï¼Œ[sysctl(8)](https://man7.org/linux/man-pages/man8/sysctl.8.html) å‘½ä»¤å°±æ˜¯ä¸“é—¨ç”¨æ¥åšè¿™ä»¶äº‹çš„ï¼š

```sh
sudo vim /etc/sysctl.conf

# åœ¨ /etc/sysctl.conf ä¸­å¢žåŠ å¦‚ä¸‹é…ç½®ï¼Œå¹¶ä¿å­˜é€€å‡º
net.ipv4.tcp_tw_recycle = 0

# reload /etc/sysctl.conf
sudo sysctl -p
```

åœ¨æ›´æ–°ä¹‹åŽï¼Œæ­¤æ•…éšœå†ä¹Ÿæ²¡æœ‰å‡ºçŽ°è¿‡ã€‚

### ç›¸å…³èµ„æ–™

è¿™ä¸ªè¿‡ç¨‹ä¸­è¿˜æŸ¥é˜…äº†å…¶ä»–èµ„æ–™ï¼š

- [What are the ramifications of setting tcp_tw_recycle/reuse to 1?](https://serverfault.com/questions/342741/what-are-the-ramifications-of-setting-tcp-tw-recycle-reuse-to-1). *serverfault.com*.
- [Dropping of connections with tcp_tw_recycle](https://stackoverflow.com/questions/8893888/dropping-of-connections-with-tcp-tw-recycle). *stackoverflow.com*.
- [Linux Advanced Routing & Traffic Control HOWTO - Chapter 13. Kernel network parameters - 13.2.1. Generic ipv4](https://tldp.org/HOWTO/Adv-Routing-HOWTO/lartc.kernel.obscure.html#AEN1252). *tldp.org*.

## è¯‘æ–‡

::: info å…³äºŽåŽŸæ–‡

ä¸ºäº†ç¡®ä¿è‡ªå·±å®Œå…¨çœ‹æ˜Žç™½ï¼ˆæ¯•ç«Ÿæ˜¯æ”¹ç”Ÿäº§çŽ¯å¢ƒçš„å†…æ ¸ç½‘ç»œå‚æ•°ï¼‰ï¼Œæˆ‘å†³å®šå°†å®ƒç¿»è¯‘æˆä¸­æ–‡ã€‚

- åŽŸæ–‡ï¼š[Coping with the TCP TIME-WAIT state on busy Linux servers](https://vincent.bernat.ch/en/blog/2014-tcp-time-wait-state-linux)
- ä½œè€…ï¼š[Vincent Bernat](https://github.com/vincentbernat)
- æ—¥æœŸï¼š2014.02.24
- è®¸å¯ï¼šæ ¹æ®ä½œè€…ç½‘ç«™çš„ [Licenses](https://vincent.bernat.ch/en/licenses) ä¿¡æ¯ï¼ŒåŽŸæ–‡é‡‡ç”¨çš„è®¸å¯è¯ä¸º [CC BY-SA 4.0](https://creativecommons.org/licenses/by-sa/4.0/)ã€‚

æœ¬è¯‘æ–‡æ²¿ç”¨ [CC BY-SA 4.0](https://creativecommons.org/licenses/by-sa/4.0/)ã€‚

:::

::: warning ðŸ“Œ ç®€è¿°

ä¸è¦å¯ç”¨ `net.ipv4.tcp_tw_recycle`â€”â€”ä»Ž Linux 4.12 å¼€å§‹è¿™ä¸ªå‚æ•°å°±ä¸å­˜åœ¨äº†ã€‚å¤§å¤šæ•°æ—¶å€™ï¼Œ`TIME-WAIT` çŠ¶æ€çš„å¥—æŽ¥å­— (sockets) æ˜¯æ— å®³çš„ã€‚å¦åˆ™ï¼Œè¯·æŸ¥çœ‹æŽ¨èè§£å†³æ–¹æ¡ˆçš„[æ€»ç»“](#æ€»ç»“)ã€‚

Linux å†…æ ¸æ–‡æ¡£å¯¹äºŽç†è§£ `net.ipv4.tcp_tw_recycle` å’Œ `net.ipv4.tcp_tw_reuse` æœ‰ä½•ä½œç”¨çš„å¸®åŠ©ä¸å¤§ã€‚ç”±äºŽç¼ºä¹æ–‡æ¡£ï¼Œè®¸å¤šè°ƒä¼˜æŒ‡å—å»ºè®®å°†è¿™ä¸¤ä¸ªå‚æ•°éƒ½è®¾ç½®ä¸º 1ï¼Œä»¥å‡å°‘ `TIME-WAIT` çŠ¶æ€çš„ sockets æ•°é‡ã€‚ç„¶è€Œï¼Œæ­£å¦‚ [tcp(7)](https://manpages.debian.org/buster/manpages/tcp.7.en.html) æ‰‹å†Œæ‰€è¿°ï¼Œ`net.ipv4.tcp_tw_recycle` é€‰é¡¹å¯¹äºŽé¢å‘å…¬ä¼—çš„æœåŠ¡å™¨æ¥è¯´æ˜¯ç›¸å½“æœ‰é—®é¢˜çš„ï¼Œå› ä¸ºå®ƒæ— æ³•å¤„ç†è¿™æ ·çš„å¤šä¸ªè¿žæŽ¥ï¼šæ¥è‡ªåŒä¸€ä¸ª NAT è®¾å¤‡èƒŒåŽçš„ä¸¤å°ä¸åŒè®¡ç®—æœºã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆéš¾æ£€æµ‹å‡ºæ¥å¹¶ä¸”å¯èƒ½ä¼šéšæ—¶å‘ä½ çš„é—®é¢˜ï¼š

> Enable fast recycling of TIME-WAIT sockets. Enabling this option is not recommended since this causes problems when working with NAT (Network Address Translation).
>
> å¯ç”¨ `TIME-WAIT` å¥—æŽ¥å­—çš„å¿«é€Ÿå›žæ”¶ã€‚ä¸å»ºè®®å¯ç”¨æ­¤é€‰é¡¹ï¼Œå› ä¸ºåœ¨ä½¿ç”¨ NATï¼ˆç½‘ç»œåœ°å€è½¬æ¢ï¼‰æ—¶å®ƒä¼šå¯¼è‡´ä¸€äº›é—®é¢˜ã€‚

:::

ä¸‹æ–‡å°†ä¼šæ›´è¯¦ç»†åœ°è§£é‡Šå¦‚ä½•æ­£ç¡®å¤„ç† `TIME-WAIT` çŠ¶æ€ã€‚å¦å¤–ï¼Œæœ¬æ–‡è®²è¿°çš„æ˜¯ Linux çš„ TCP åè®®æ ˆã€‚è¿™ä¸Ž *Netfilter* è¿žæŽ¥è¿½è¸ªå®Œå…¨æ— å…³ï¼Œå®ƒå¯ä»¥é€šè¿‡å…¶ä»–æ–¹å¼è¿›è¡Œè°ƒæ•´ [^netfilter]ã€‚

[^netfilter]: å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè°ƒæ•´ `net.netfilter.nf_conntrack_tcp_timeout_time_wait` ä¸ä¼šæ”¹å˜ TCP åè®®æ ˆå¤„ç† `TIME-WAIT` çŠ¶æ€çš„æ–¹å¼ã€‚

## å…³äºŽ `TIME-WAIT` çŠ¶æ€

è®©æˆ‘ä»¬å…ˆå›žé¡¾ä¸€ä¸‹ä»€ä¹ˆæ˜¯ `TIME-WAIT` çŠ¶æ€ï¼Œå‚è§ä¸‹é¢çš„ TCP çŠ¶æ€å›¾[^tcp_diagram]ï¼š

![TCP State Diagram](./tcp-state-diagram.svg)

[^tcp_diagram]: è¯¥å›¾çš„è®¸å¯è¯ä¸º [LaTeX Project Public License 1.3](https://www.latex-project.org/lppl.txt)ã€‚åŽŸå§‹æ–‡ä»¶å¯åœ¨æ­¤[é¡µé¢](http://www.texample.net/tikz/examples/tcp-state-machine/)ä¸Šæ‰¾åˆ°ã€‚

åªæœ‰*å…ˆå…³é—­è¿žæŽ¥çš„ä¸€ç«¯*æ‰ä¼šè¿›å…¥ `TIME-WAIT` çŠ¶æ€ã€‚å¦ä¸€ç«¯åˆ™ä¼šéµå¾ªä½¿å®ƒå¿«é€Ÿä¸¢å¼ƒè¿žæŽ¥çš„è·¯å¾„ã€‚

ä½ å¯ä»¥ä½¿ç”¨ `ss -tan` æŸ¥çœ‹å½“å‰çš„è¿žæŽ¥çŠ¶æ€ï¼š

```sh
$ ss -tan | head -5
LISTEN     0  511             *:80              *:*
SYN-RECV   0  0     192.0.2.145:80    203.0.113.5:35449
SYN-RECV   0  0     192.0.2.145:80   203.0.113.27:53599
ESTAB      0  0     192.0.2.145:80   203.0.113.27:33605
TIME-WAIT  0  0     192.0.2.145:80   203.0.113.47:50685
```

### ç”¨é€”

>>>>> progress

## æ€»ç»“
